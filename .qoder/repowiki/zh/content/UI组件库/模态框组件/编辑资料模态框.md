# 编辑资料模态框

<cite>
**本文档引用文件**  
- [EditProfileModal.tsx](file://src/components/EditProfileModal.tsx)
- [index.ts](file://src/store/index.ts)
- [Toast.tsx](file://src/components/Toast.tsx)
- [Settings.tsx](file://src/pages/Settings.tsx)
- [supabase.ts](file://src/lib/supabase.ts)
</cite>

## 目录
1. [简介](#简介)
2. [核心功能与架构](#核心功能与架构)
3. [React Portal 与模态框渲染机制](#react-portal-与模态框渲染机制)
4. [Zustand 状态管理集成](#zustand-状态管理集成)
5. [表单字段设计](#表单字段设计)
6. [输入验证逻辑](#输入验证逻辑)
7. [加载状态与错误反馈](#加载状态与错误反馈)
8. [Props 接口说明](#props-接口说明)
9. [事件处理机制](#事件处理机制)
10. [在 Settings 页面中的调用示例](#在-settings-页面中的调用示例)
11. [常见问题与解决方案](#常见问题与解决方案)
12. [动画效果实现](#动画效果实现)

## 简介
`EditProfileModal` 是一个用于编辑用户个人资料的模态框组件，支持昵称、头像、生日、性别和个人简介等信息的修改。该组件通过 React Portal 的渲染方式脱离父级布局限制，确保模态框始终居中显示于页面顶层。它与 Zustand 状态管理库深度集成，使用 `useAuthStore` 读取当前用户资料，并在提交时调用 `updateProfile` 方法将数据同步至 Supabase 数据库。同时，组件内置表单验证、加载状态、错误提示及 Toast 通知机制，提供完整的用户体验。

## 核心功能与架构
`EditProfileModal` 组件实现了用户资料编辑的核心流程，包括数据初始化、表单输入、验证、提交和反馈。其架构基于 React 函数组件与 Hooks，结合 Zustand 进行全局状态管理，通过 Supabase 客户端直接与后端数据库交互。

**组件结构**
- 使用 `useState` 管理本地表单数据、错误信息、加载状态和 Toast 显示
- 使用 `useEffect` 在用户资料加载后初始化表单
- 集成 `Toast` 组件实现操作结果的可视化反馈
- 通过 `onClose` 回调控制模态框的显隐

**Section sources**
- [EditProfileModal.tsx](file://src/components/EditProfileModal.tsx#L1-L434)

## React Portal 与模态框渲染机制
尽管 `EditProfileModal` 未显式使用 `ReactDOM.createPortal`，但其通过 `fixed` 定位实现了类似 Portal 的效果。模态框外层容器使用 `className="fixed inset-0"`，使其脱离文档流并覆盖整个视口，确保无论父组件布局如何，模态框都能居中显示。

该容器的 `z-50` 层级确保其位于其他内容之上，背景层使用 `bg-black bg-opacity-50` 实现半透明遮罩，增强视觉聚焦。整个模态框内容被包裹在一个 `max-w-md` 的白色卡片中，限制宽度并允许垂直滚动（`max-h-[90vh] overflow-y-auto`），适配不同屏幕尺寸。

**Section sources**
- [EditProfileModal.tsx](file://src/components/EditProfileModal.tsx#L408-L434)

## Zustand 状态管理集成
`EditProfileModal` 通过 `useAuthStore` Hook 与 Zustand 状态管理器集成，实现对用户身份和资料的统一管理。

### 状态读取
组件从 `useAuthStore` 中解构出 `user`、`profile` 和 `updateProfile`：
```ts
const { user, profile, updateProfile } = useAuthStore()
```
- `user`：包含用户身份信息（如 ID、邮箱）
- `profile`：存储用户资料（昵称、头像、生日等）
- `updateProfile`：用于提交更新的异步方法

### 表单初始化
通过 `useEffect` 监听 `profile` 变化，自动填充表单字段：
```ts
useEffect(() => {
  if (profile) {
    setFormData({
      name: profile.name || '',
      username: profile.username || '',
      avatar_url: profile.avatar_url || '',
      bio: (profile as any).bio || '',
      birthday: (profile as any).birthday || '',
      gender: (profile as any).gender || ''
    })
    setOriginalUsername(profile.username || '')
  }
}, [profile])
```
此机制确保用户打开模态框时，表单已预填当前资料。

### 资料更新
提交时调用 `updateProfile(formData)`，该方法内部根据用户类型（Supabase 或本地）决定更新策略：
- Supabase 用户：通过 Supabase 客户端更新数据库
- 本地用户：更新 `localStorage`

**Section sources**
- [EditProfileModal.tsx](file://src/components/EditProfileModal.tsx#L11-L30)
- [index.ts](file://src/store/index.ts#L39-L227)

## 表单字段设计
组件包含以下表单字段，支持用户资料的全面编辑：

### 头像上传
- 支持两种方式：上传本地图片或输入图片 URL
- 上传功能通过隐藏的 `<input type="file">` 实现，点击图标触发
- 文件限制：仅允许图片类型（`image/*`），大小不超过 5MB
- 上传成功后使用 `FileReader` 生成预览 URL 并更新表单

### 基本信息
- **姓名**：必填项，长度限制 50 字符
- **用户名**：必填项，格式要求为 3-20 位字母、数字或下划线，且需唯一
- **生日**：日期选择器输入，禁止未来日期
- **性别**：下拉选择（男、女、其他）
- **个人简介**：可选字段，最大长度 500 字符，实时显示字数统计

**Section sources**
- [EditProfileModal.tsx](file://src/components/EditProfileModal.tsx#L245-L394)

## 输入验证逻辑
组件在提交前执行严格的客户端验证，确保数据完整性。

### 验证规则
| 字段 | 验证规则 |
|------|--------|
| 姓名 | 非空，长度 ≤ 50 |
| 用户名 | 非空，符合 `/^[a-zA-Z0-9_]{3,20}$/`，且在数据库中唯一 |
| 头像URL | 若填写，必须为有效 URL |
| 生日 | 若填写，必须为有效日期，且不为未来日期 |
| 个人简介 | 若填写，长度 ≤ 500 |

### 异步唯一性检查
用户名的唯一性通过 `checkUsernameUnique` 函数异步验证：
```ts
const { data, error } = await supabase
  .from('user_profiles')
  .select('id')
  .eq('username', username)
  .neq('id', user?.id || '')
  .single()
```
若查询返回数据，则用户名已被占用。验证过程中显示加载动画（`Loader2` 图标），提升用户体验。

**Section sources**
- [EditProfileModal.tsx](file://src/components/EditProfileModal.tsx#L100-L198)

## 加载状态与错误反馈
组件通过多种机制提供操作反馈，确保用户感知当前状态。

### 加载状态
- 提交时设置 `loading = true`，禁用保存按钮
- 按钮显示“保存中...”及旋转加载图标
- 成功后延迟 1.5 秒关闭模态框，确保用户看到成功提示

### 错误反馈
- 字段级错误：每个输入框下方显示红色错误消息
- 操作级反馈：通过 `Toast` 组件显示全局通知
  - 成功：绿色背景，显示“资料更新成功！”
  - 失败：红色背景，显示“更新失败，请重试”
  - 警告：黄色背景，显示“请检查表单信息”

`Toast` 组件通过 `setToast` 控制显示，3 秒后自动消失。

**Section sources**
- [EditProfileModal.tsx](file://src/components/EditProfileModal.tsx#L208-L234)
- [Toast.tsx](file://src/components/Toast.tsx#L3-L81)

## Props 接口说明
`EditProfileModal` 接收以下 props：

| 属性 | 类型 | 必需 | 描述 |
|------|------|------|------|
| `isOpen` | `boolean` | 是 | 控制模态框是否显示 |
| `onClose` | `() => void` | 是 | 关闭模态框时的回调函数 |

该组件未暴露 `onSuccess` 回调，但可通过 `onClose` 结合状态变化间接实现。

**Section sources**
- [EditProfileModal.tsx](file://src/components/EditProfileModal.tsx#L6-L9)

## 事件处理机制
组件实现了完整的事件处理流程，确保交互流畅。

### 遮罩点击关闭
模态框外层遮罩（`bg-black bg-opacity-50`）点击时触发 `onClose`，实现点击外部关闭功能。

### 关闭按钮
右上角 `X` 按钮和底部“取消”按钮均调用 `onClose`，关闭模态框。

### 表单输入
使用通用的 `handleInputChange` 函数处理所有字段输入，动态更新 `formData` 并清除对应字段的错误提示。

### 阻止事件冒泡
所有按钮点击事件均通过 React 自动处理，无需手动阻止冒泡。遮罩点击关闭逻辑清晰，不会影响内部表单操作。

**Section sources**
- [EditProfileModal.tsx](file://src/components/EditProfileModal.tsx#L208-L234)

## 在 Settings 页面中的调用示例
`EditProfileModal` 在 `Settings` 页面中被集成使用，通过状态控制显隐。

### 状态管理
```ts
const [showEditProfile, setShowEditProfile] = useState(false)
```

### 触发按钮
在“个人信息”设置项中，点击“编辑资料”触发模态框：
```tsx
{
  icon: User,
  label: '编辑资料',
  value: '',
  action: () => setShowEditProfile(true)
}
```

### 组件渲染
模态框作为子组件在 JSX 中条件渲染：
```tsx
<EditProfileModal 
  isOpen={showEditProfile}
  onClose={() => setShowEditProfile(false)}
/>
```

此模式实现了清晰的控制流：点击按钮 → 设置状态 → 模态框显示 → 用户操作 → 提交或关闭 → 状态重置。

**Section sources**
- [Settings.tsx](file://src/pages/Settings.tsx#L100-L110)

## 常见问题与解决方案
### 问题：关闭模态框后表单残留数据
由于 `useEffect` 仅在 `profile` 变化时初始化表单，若用户多次打开模态框，可能显示上次编辑的未保存内容。

### 解决方案：监听 `isOpen` 重置表单
应在 `useEffect` 中同时监听 `isOpen`，当模态框关闭时重置表单：
```ts
useEffect(() => {
  if (isOpen && profile) {
    // 仅在打开时初始化
    setFormData({ /* ... */ })
    setOriginalUsername(profile.username || '')
  }
}, [isOpen, profile])
```
或在 `onClose` 前手动重置：
```ts
const handleClose = () => {
  setFormData(initialState)
  onClose()
}
```
当前实现依赖 `profile` 更新自动同步，但在频繁打开场景下建议显式重置。

**Section sources**
- [EditProfileModal.tsx](file://src/components/EditProfileModal.tsx#L50-L58)

## 动画效果实现
模态框的动画效果完全由 Tailwind CSS 的过渡类实现，无需额外 JavaScript 动画库。

### 淡入淡出与缩放
- 遮罩使用 `bg-opacity-50` 配合 `transition` 实现渐显
- 内容卡片虽未显式定义 `transition`，但通过父级布局变化自然呈现
- `Toast` 组件使用 `animate-in slide-in-from-right duration-300` 实现从右滑入的动画

### 交互反馈
- 按钮使用 `transition-colors` 实现颜色渐变
- 头像上传按钮使用 `hover:bg-orange-600` 提供悬停反馈
- 加载图标使用 `animate-spin` 实现旋转动画

这些类确保了流畅的视觉体验，符合现代 Web 应用的设计标准。

**Section sources**
- [EditProfileModal.tsx](file://src/components/EditProfileModal.tsx#L408-L434)
- [Toast.tsx](file://src/components/Toast.tsx#L45-L81)