# 编译与打包

<cite>
**本文档引用的文件**  
- [MOBILE_BUILD_GUIDE.md](file://MOBILE_BUILD_GUIDE.md)
- [android/gradle.properties](file://android/gradle.properties)
- [android/app/build.gradle](file://android/app/build.gradle)
- [android/app/src/main/AndroidManifest.xml](file://android/app/src/main/AndroidManifest.xml)
- [capacitor.config.ts](file://capacitor.config.ts)
</cite>

## 目录
1. [简介](#简介)
2. [构建环境与前置条件](#构建环境与前置条件)
3. [使用gradlew.bat执行构建](#使用gradlew.bat执行构建)
4. [构建类型与构建变体](#构建类型与构建变体)
5. [Release版本的代码签名机制](#release版本的代码签名机制)
6. [AAB与APK格式选择策略](#aab与apk格式选择策略)
7. [AndroidManifest.xml关键配置分析](#androidmanifest.xml关键配置分析)
8. [常见编译问题及解决方案](#常见编译问题及解决方案)
9. [总结](#总结)

## 简介
本文档深入讲解Android平台的编译与打包全过程，基于`MOBILE_BUILD_GUIDE.md`中的实践步骤，结合项目实际配置文件，系统性地指导开发者如何通过命令行完成debug与release构建，理解构建变体差异，配置代码签名，并解决常见编译问题。

**Section sources**  
- [MOBILE_BUILD_GUIDE.md](file://MOBILE_BUILD_GUIDE.md#L1-L250)

## 构建环境与前置条件
在开始Android构建前，需确保以下环境已正确配置：
- Node.js 18+
- Android Studio
- Java JDK 17+
- Gradle（由Android项目自动管理）

项目使用Capacitor框架将Web应用打包为原生应用，因此需通过`pnpm`执行相关命令进行资源同步与构建。

**Section sources**  
- [MOBILE_BUILD_GUIDE.md](file://MOBILE_BUILD_GUIDE.md#L45-L50)

## 使用gradlew.bat执行构建
`gradlew.bat`是Android项目的Gradle Wrapper脚本，用于在Windows环境下执行构建任务，避免本地Gradle版本不一致问题。

### 执行Debug构建
```bash
cd android
./gradlew assembleDebug
```
该命令将生成未签名的调试版本APK，输出路径为：`android/app/build/outputs/apk/debug/app-debug.apk`。

### 执行Release构建
```bash
cd android
./gradlew assembleRelease
```
该命令生成用于发布的APK，位于`android/app/build/outputs/apk/release/app-release.apk`，但需先配置签名信息。

**Section sources**  
- [MOBILE_BUILD_GUIDE.md](file://MOBILE_BUILD_GUIDE.md#L90-L105)
- [android/app/build.gradle](file://android/app/build.gradle#L18-L22)

## 构建类型与构建变体
Android构建系统支持多种构建类型（Build Types）和产品风味（Product Flavors），组合形成构建变体（Build Variants）。

### 当前项目构建类型
项目中定义了两种构建类型：
- **debug**: 默认启用调试功能，输出`app-debug.apk`
- **release**: 禁用调试，用于发布，输出`app-release.apk`

```gradle
buildTypes {
    release {
        minifyEnabled false
        proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
    }
}
```

**适用场景**：
- `debug`：开发调试、内部测试
- `release`：正式发布、Google Play上传

**Section sources**  
- [android/app/build.gradle](file://android/app/build.gradle#L18-L22)
- [MOBILE_BUILD_GUIDE.md](file://MOBILE_BUILD_GUIDE.md#L90-L105)

## Release版本的代码签名机制
发布版本必须经过数字签名，以确保应用完整性和开发者身份认证。

### 生成Keystore文件
使用`keytool`生成签名密钥：
```bash
keytool -genkey -v -keystore my-release-key.keystore -alias my-key-alias -keyalg RSA -keysize 2048 -validity 10000
```

### 配置gradle.properties
在`android/gradle.properties`中添加签名参数：
```properties
MYAPP_RELEASE_STORE_FILE=my-release-key.keystore
MYAPP_RELEASE_KEY_ALIAS=my-key-alias
MYAPP_RELEASE_STORE_PASSWORD=*****
MYAPP_RELEASE_KEY_PASSWORD=*****
```

### 在build.gradle中集成签名配置
虽然当前`build.gradle`未显式配置签名，但标准做法如下：
```gradle
android {
    ...
    signingConfigs {
        release {
            storeFile file(MYAPP_RELEASE_STORE_FILE)
            storePassword MYAPP_RELEASE_STORE_PASSWORD
            keyAlias MYAPP_RELEASE_KEY_ALIAS
            keyPassword MYAPP_RELEASE_KEY_PASSWORD
        }
    }
    buildTypes {
        release {
            signingConfig signingConfigs.release
            ...
        }
    }
}
```

**Section sources**  
- [MOBILE_BUILD_GUIDE.md](file://MOBILE_BUILD_GUIDE.md#L75-L90)
- [android/gradle.properties](file://android/gradle.properties#L1-L23)
- [android/app/build.gradle](file://android/app/build.gradle#L18-L22)

## AAB与APK格式选择策略
### APK (Android Package)
- 传统安装包格式
- 包含所有资源，体积较大
- 可直接安装在设备上

### AAB (Android App Bundle)
- Google Play推荐格式
- 按设备配置动态生成优化的APK
- 减少应用体积，提升下载效率

### Google Play发布要求
- 推荐使用AAB格式上传
- 支持App Signing功能，由Google管理签名密钥
- 提供更精细的分发控制（如按国家、设备类型）

当前项目可通过Android Studio选择`Build Bundle(s) / APK(s)` → `Build Bundle(s)`生成AAB文件。

**Section sources**  
- [MOBILE_BUILD_GUIDE.md](file://MOBILE_BUILD_GUIDE.md#L130-L145)

## AndroidManifest.xml关键配置分析
`AndroidManifest.xml`定义了应用的基本属性和权限。

### application属性
```xml
<application
    android:allowBackup="true"
    android:icon="@mipmap/ic_launcher"
    android:label="@string/app_name"
    android:roundIcon="@mipmap/ic_launcher_round"
    android:supportsRtl="true"
    android:theme="@style/AppTheme">
```
- `allowBackup`: 允许系统备份应用数据
- `icon` 和 `roundIcon`: 应用图标
- `label`: 应用名称（引用`strings.xml`）
- `supportsRtl`: 支持从右到左语言布局
- `theme`: 应用主题样式

### 权限配置
```xml
<uses-permission android:name="android.permission.INTERNET" />
```
声明应用需要访问网络权限，这是大多数应用的基本权限。

### MainActivity配置
- `launchMode="singleTask"`: 启动模式为单任务
- `exported="true"`: 允许其他应用启动此Activity
- 配置了`LAUNCHER` Intent Filter，作为应用入口

**Section sources**  
- [android/app/src/main/AndroidManifest.xml](file://android/app/src/main/AndroidManifest.xml#L1-L42)

## 常见编译问题及解决方案
### Gradle版本冲突
- **现象**：构建失败，提示版本不兼容
- **解决方案**：
  - 检查`gradle-wrapper.properties`中的Gradle版本
  - 确保Android Gradle Plugin版本与Gradle版本兼容
  - 清理构建缓存：`cd android && ./gradlew clean`

### 内存不足
- **现象**：`OutOfMemoryError`
- **解决方案**：
  - 增加Gradle堆内存，在`gradle.properties`中设置：
    ```properties
    org.gradle.jvmargs=-Xmx2048m -XX:MaxMetaspaceSize=512m
    ```

### 依赖解析失败
- **现象**：`Could not resolve`错误
- **解决方案**：
  - 检查网络连接和仓库配置
  - 清理Gradle缓存：`./gradlew --refresh-dependencies`
  - 更新`android/build.gradle`中的依赖版本

### 其他问题
- **Java版本不匹配**：确保使用JDK 17+
- **SDK未安装**：通过Android Studio SDK Manager安装对应版本
- **Capacitor同步问题**：运行`pnpm cap:sync`重新同步Web资源

**Section sources**  
- [MOBILE_BUILD_GUIDE.md](file://MOBILE_BUILD_GUIDE.md#L200-L230)

## 总结
本文档系统性地讲解了Android编译与打包的全过程，涵盖从环境配置、构建命令执行、签名机制到常见问题解决。通过结合`MOBILE_BUILD_GUIDE.md`和项目实际配置文件，提供了可操作的实践指导。开发者应根据发布需求选择合适的构建类型和输出格式，并严格遵循代码签名规范，确保应用安全可靠地发布到Google Play。